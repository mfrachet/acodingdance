---
title: "Automatically auditing Gatsby sites with Lighthouse"
date: 2020-12-18
slug: "/automatically-auditing-gatsby-sites-with-lighthouse"
metaImage: ./gatsbyjs.png
metaKeywords: "jamstack,lighthouse,performances,gatsby"
---

![Gatsbyjs](./gatsbyjs.png)


**This is a recipe** on how to automate [Lighthouse](https://developers.google.com/web/tools/lighthouse) audits for every pages generated by [Gatsby](https://www.gatsbyjs.com/), thanks to the `sitemap.xml` file.

## Before starting

You would need to get familiar with:

- The [JAMstack](https://jamstack.org/) is a way to build websites by statically generating as many static file as necessary from a data source
- [Gatsby](https://www.gatsbyjs.com/) is a mainstream tool in the JAMstack ecosystem
- [Lighthouse](https://developers.google.com/web/tools/lighthouse) is a tool that aims to automatically audit websites and provide hints on improvements ways
- Being familiar with the [`sitemap.xml` file](https://en.wikipedia.org/wiki/Sitemaps)


## Ingredients

- A Gatsby site
- The [gatsby-plugin-sitemap](https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-plugin-sitemap) plugin
- The [xml2js](https://www.npmjs.com/package/xml2js) to convert the `sitemap.xml` into a JSON array
- The [Lighthouse node module](https://github.com/GoogleChrome/lighthouse#using-the-node-module) to run the audit programmatically


## Preparation steps

### 1. Adding the [gatsby-plugin-sitemap](https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-plugin-sitemap) plugin

In your Gatsby website, run the following command:

```shell
$ yarn gatsby-plugin-sitemap
# or
$ npm install --save gatsby-plugin-sitemap
```

Then add the plugin to the `gatsby-config.js` plugins option. Also make sure that there is a `siteMetada.siteUrl` field available and pointing to the production URL of the website:

```javascript
module.exports = {
    siteMetadata: {
        siteUrl: `https://mfrachet.github.io`,
    },
    plugins: [`gatsby-plugin-sitemap`],
};
```

After running `$ gatsby build`, you may end up generating a `sitemap.xml` in the `./public` folder of your project looking like:

```xml
```xml
<urlset
    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
    xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:mobile="http://www.google.com/schemas/sitemap-mobile/1.0"
    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"
    xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">
    <url>
        <loc>https://mfrachet.github.io/a-b-testing-with-the-jamstack</loc>
        <changefreq>daily</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://mfrachet.github.io/the-n-props-syndrome</loc>
        <changefreq>daily</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://mfrachet.github.io/how-do-i-choose-a-ssr-strategy</loc>
        <changefreq>daily</changefreq>
        <priority>0.7</priority>
    </url>
</urlset>
```

_NB: the previous sitemap.xml is the one associated to the https://mfrachet.github.io/ website. Yours may look different._


### 2. Transforming the sitemap.xml into a JSON array

For this step, the `xml2js` module is required. Make sure to run the following command at the run of your project:

```shell
$ yarn add xml2js
```

Let's now create a `./scripts/audit-gatsby.js` file and add the following function to it:

```js
const { join } = require('path');
const parseStringPromise = require('xml2js').parseStringPromise;
const fs = require('fs');

const extractUrlsFromSitemap = async () => {
    // Resolve the path of the sitemap.xml file
    // By default, it's located in the ./public folder of the project
    // when running NODE_ENV=prod gatsby build
    const filepath = join(process.cwd(), 'public', 'sitemap.xml');

    // Read the string content of the sitemap.xml file
    const fileContent = fs.readFileSync(filepath, 'utf-8');

    // Transform the string content (which is written in XML) into a json object
    const json = await parseStringPromise(fileContent);

    // Browse into the particular shape of the object we get back from the xml2js library
    const urls = json.urlset.url.map((uri) => {
        const url = uri.loc[0];

        // Remember that sitemap.xml is built using the siteMetadata.siteUrl config provided by
        // the gatsby-plugin-sitemap plugin.
        // We need to replace this production URL by a localhost one in order to run the test locally
        const prodPath = `https://mfrachet.github.io`;
        const localPath = `http://localhost:3000`;

        return url.replace(prodPath, localPath);
    });

    // urls should look like:
    // [
    //  "http://localhost:3000/a-b-testing-with-the-jamstack",
    //  "http://localhost:3000/the-n-props-syndrome",
    //  "http://localhost:3000/how-do-i-choose-a-ssr-strategy"
    // ]
    return urls;
};

```


### 3. Running Lighthouse audits on the JSON array of URLs

Thanks to the previous step, we can now iterate and run Lighthouse audits using the following array:

```json
[
    "http://localhost:3000/a-b-testing-with-the-jamstack",
    "http://localhost:3000/the-n-props-syndrome",
    "http://localhost:3000/how-do-i-choose-a-ssr-strategy"
]
```

Let's add the following code to the  `./scripts/audit-gatsby.js` file:

```javascript
/* previously imported modules go here */

// chrome-launcher is a tool that allows to start Chrome and to use the drive it with the devtools protocol
const chromeLauncher = require("chrome-launcher");
const lighthouse = require("lighthouse");

const extractUrlsFromSitemap = async () => { /* previously implemented function code */}

// Let's define performance budgets for the site
const PERFORMANCE_BUDGET = 50;

const auditUrls = async (urls) => {
  // this creates a chrome instance
  const chrome = await chromeLauncher.launch();

  // defining Lighthouse options so that it knows on which chrome instance it has to connect
  const options = { port: chrome.port };

  // for each URL, run a Lighthouse audit
  // throw an error when the threshold is crossed.
  // NB: lighthouse retrieves score in decimal like: 0.4. We need to multiply it by 100 to get a percentage value
  for (const url of urls) {
    const runnerResult = await lighthouse(url, options);
    const performance = runnerResult.lhr.categories.performance;

    if (performance.score * 100 < PERFORMANCE_BUDGET) {
      await chrome.kill();
      throw new Error("Oops! Performance thresholds crossed!");
    }
  }

  // Nothing thrown, every tests have succeeded!
  console.log("Everything is passing! Congrats!");
  await chrome.kill();
};

// Connect the extractUrlsFromSitemap function and the auditUrls one
const main = async () => {
    const urls = await extractUrlsFromSitemap()
    await auditUrls(urls)
}

// Run the audits when node ./scripts/index.js is called
main()
```

### 4. Running the audits from the CLI

Add the following to the `scripts` entry of the project `package.json`:

```json
{
    "name": "my-project",
    "scripts": {
        "audit": "NODE_ENV=prod gatsby build && node ./scripts/audit-gatsby.js",
    }
}
```

And then run the following command at the root of the project:

```javascript
$ yarn audit
```

You should see the Lighthouse audits running on all the pages of your site.

![Lighthouse auditing a whole blog](./audit-blog.gif)